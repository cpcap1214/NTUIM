#!/bin/bash

# å°å¤§è³‡ç®¡ç³»å­¸æœƒç¶²ç«™ - è€ƒå¤é¡Œç³»çµ±é›™æª”æ¡ˆåŠŸèƒ½éƒ¨ç½²è…³æœ¬
# åŸ·è¡Œå‰è«‹ç¢ºèªï¼š
# 1. å·²ç¶“ git push æœ€æ–°ç¨‹å¼ç¢¼åˆ°é ç«¯å€‰åº«
# 2. å·²ç¶“å‚™ä»½é‡è¦çš„è€ƒå¤é¡Œè³‡æ–™

echo "ğŸš€ é–‹å§‹éƒ¨ç½²è€ƒå¤é¡Œé›™æª”æ¡ˆç³»çµ±æ›´æ–°..."

# 1. é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd ~/NTUIM || exit 1
echo "ğŸ“‚ é€²å…¥å°ˆæ¡ˆç›®éŒ„: $(pwd)"

# 2. æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼
echo "ğŸ“¥ æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼..."
git pull origin main

# 3. åœæ­¢å¾Œç«¯æœå‹™
echo "ğŸ›‘ åœæ­¢å¾Œç«¯æœå‹™..."
pm2 stop ntuim-backend

# 4. å‚™ä»½ç¾æœ‰è³‡æ–™åº«ï¼ˆå¯é¸ä½†å»ºè­°ï¼‰
echo "ğŸ’¾ å‚™ä»½ç¾æœ‰è³‡æ–™åº«..."
cp src/backend/database/ntuim.db src/backend/database/ntuim.db.backup.$(date +%Y%m%d_%H%M%S)

# 5. åŸ·è¡Œè³‡æ–™åº«çµæ§‹æ›´æ–°
echo "ğŸ—„ï¸ æ›´æ–°è³‡æ–™åº«çµæ§‹..."
sqlite3 src/backend/database/ntuim.db < src/backend/database/update_exams_table.sql

# 6. é©—è­‰è³‡æ–™åº«çµæ§‹
echo "âœ… é©—è­‰è³‡æ–™åº«çµæ§‹..."
sqlite3 src/backend/database/ntuim.db ".schema exams"

# 7. é‡æ–°å•Ÿå‹•å¾Œç«¯æœå‹™
echo "ğŸ”„ é‡æ–°å•Ÿå‹•å¾Œç«¯æœå‹™..."
pm2 start ntuim-backend

# 8. æª¢æŸ¥æœå‹™ç‹€æ…‹
echo "ğŸ“Š æª¢æŸ¥æœå‹™ç‹€æ…‹..."
pm2 status ntuim-backend

# 9. æª¢æŸ¥å¾Œç«¯æ—¥èªŒ
echo "ğŸ“‹ æª¢æŸ¥å¾Œç«¯æ—¥èªŒ (æœ€å¾Œ 10 è¡Œ)..."
pm2 logs ntuim-backend --lines 10

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ“ è«‹æ¸¬è©¦ä»¥ä¸‹åŠŸèƒ½ï¼š"
echo "   1. ç®¡ç†å“¡ä¸Šå‚³è€ƒå¤é¡Œï¼ˆé¡Œç›®æª”æ¡ˆ + å¯é¸ç­”æ¡ˆæª”æ¡ˆï¼‰"
echo "   2. å­¸ç”Ÿç€è¦½å’Œä¸‹è¼‰è€ƒå¤é¡Œ"
echo "   3. é è¦½åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œ"

echo ""
echo "ğŸ” å¦‚æœé‡åˆ°å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š"
echo "   - pm2 logs ntuim-backend"
echo "   - è³‡æ–™åº«æª”æ¡ˆæ¬Šé™"
echo "   - ä¸Šå‚³ç›®éŒ„æ¬Šé™"